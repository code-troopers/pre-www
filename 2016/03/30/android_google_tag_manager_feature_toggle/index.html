
<!doctype html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="stylesheet" href="/styles.b4a3.css" /></head>

<body>


<header>
    <nav>
        <a href="/" class="brand"><img src="/img/Code-Troopers.06da.png" alt="Code-Troopers"></a>
        
            
            <a href="/#skills" class=" "><span>Compétences</span></a>
            
        
            
            <a href="/#portfolio" class=" "><span>Réalisations</span></a>
            
        
            
            <a href="/#casting" class=" "><span>Casting</span></a>
            
        
            
            <a href="/#contact" class=" "><span>Contact</span></a>
            
        
            
            <a href="/blog" class=" active  blog"><span>Blog</span></a>
            
        
            
        
    </nav>
</header>
<section id="blog">
    <div class="wrapper">
        <h1>
            Blog
        </h1>
    </div>

    <section id="article">
        <div class="wrapper">
            <article>
                
                <img src="/images/banner/android-banner.c728.png">
                
                
                
                <h2>Android : Feature Toggle avec Google Tag Manager</h2>
                
                
                <ul class="tags">
                    
                    <li><a href="/tags/android/">Android</a></li>
                    
                    <li><a href="/tags/google-tag-manager/">Google Tag Manager</a></li>
                    
                    <li><a href="/tags/feature-toggle/">Feature Toggle</a></li>
                    
                </ul>
                
                <div class="content">
                    <div class="paragraph">
<p>Le concept de <code>feature toggle</code> est bien pratique en tant que développeur si l&#8217;on souhaite faire évoluer sa base de code source à un rythme différent de celui des livraisons et des fonctionnalités.
C&#8217;est souvent le cas lorsqu&#8217;il y a autour du produit une équipe marketing / communication qui s&#8217;occupe d&#8217;annoncer telle ou telle nouvelle fonctionnalité.</p>
</div>
<div class="paragraph">
<p>Le problème avec Android c&#8217;est qu&#8217;il peut être vite problématique d&#8217;utiliser ces features toggle, car une fois l&#8217;application arrivée sur le téléphone des utilisateurs le développeur n&#8217;a plus
la possibilité de changer la valeur des flags autrement qu&#8217;en relivrant l&#8217;application, ce qui peut vite se terminer par du spam d&#8217;updates si les activations/désactivations sont trop fréquentes ou trop rapprochées.</p>
</div>
<div class="paragraph">
<p>C&#8217;est là qu&#8217;entre en jeu <code>Google Tag Manager</code>, cet outil made by Google va nous offrir la possibilité d&#8217;activer/désactiver lesdites fonctionnalités et cela sans avoir à redéployer l&#8217;application sur le store.</p>
</div>
<div class="sect1">
<h2 id="_google_tag_manager_la_configuration">Google Tag Manager : La configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pour commencer, il faut aller dans l&#8217;interface dédiée de <a href="https://tagmanager.google.com">Google Tag Manager</a> afin de générer la configuration nécessaire pour notre application.
C&#8217;est via cette IHM et avec les informations que l&#8217;on va y ajouter que l&#8217;on pourra revenir plus tard et modifier des valeurs qui seront prises en compte dans l&#8217;application Android.</p>
</div>
<div class="paragraph">
<p>La mise en place d&#8217;une configuration pour une application Android passe donc par les étapes suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Créez un nouveau container (ce qui correspond à créer la configuration pour une application).</p>
</li>
<li>
<p>Donnez-lui le nom que vous voulez et sélectionnez le type <code>Android</code>.</p>
</li>
<li>
<p>Une fois le container créé un code unique du type <code>GTM-XXXXXX</code> lui est attribué par Google notez-le, il sera utilisé dans le code de l&#8217;application Android.</p>
</li>
<li>
<p>Ensuite dans ce container rendez-vous dans la partie <code>Variables</code> et créez une nouvelle variable.</p>
</li>
<li>
<p>Choisissez le type <code>Value Collection</code>.</p>
</li>
<li>
<p>Définissez sa valeur avec un objet json { 'clé' : 'valeur' }, la clé sera elle aussi réutilisée dans le code Android et la valeur peut être ce que vous souhaitez (ici un boolean ira très bien).</p>
</li>
<li>
<p>N&#8217;oubliez d&#8217;activer cette variable en sélectionnant Enable : <code>Always</code>.</p>
</li>
<li>
<p>Sauvegardez la variable.</p>
</li>
<li>
<p>Vous pouvez dès à présent publier le container, il est prêt à être utilisé.</p>
</li>
<li>
<p>Avant de quitter cet écran une dernière opération utile, téléchargez la première version publiée du container, il sera nécessaire de l&#8217;embarquer dans le code source en tant que configuration initiale.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces étapes sont résumées dans ces écrans :</p>
</div>
<div class="paragraph">
<p><div style="text-align : center">
<a class="inlineBoxes" href="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_containerCreation1.1ab3.png" data-lightbox="0" title="Création du container">
        <img class="medium" src="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_containerCreation1_min.6d63.png" alt="Création du container"/>
</a>
<a class="inlineBoxes" href="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_containerCreation2.5242.png" data-lightbox="0" title="Création du container - Nom et type">
        <img class="medium" src="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_containerCreation2_min.5e4f.png" alt="Création du container - Nom et type"/>
</a>
<a class="inlineBoxes" href="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_gtmIdGenerated.dac3.png" data-lightbox="0" title="GTM id généré">
        <img class="medium" src="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_gtmIdGenerated_min.9967.png" alt="GTM id généré"/>
</a>
<a class="inlineBoxes" href="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_screenVariables.4353.png" data-lightbox="0" title="Écran 'Variables'">
        <img class="medium" src="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_screenVariables_min.0e4d.png" alt="Écran 'Variables'"/>
</a>
<a class="inlineBoxes" href="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_createVariable.d6ed.png" data-lightbox="0" title="Création d&#8217;une nouvelle variable">
        <img class="medium" src="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_createVariable_min.5788.png" alt="Création d&#8217;une nouvelle variable"/>
</a>
<a class="inlineBoxes" href="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_publishContainer.73c3.png" data-lightbox="0" title="Publication du container">
        <img class="medium" src="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_publishContainer_min.e1ad.png" alt="Publication du container"/>
</a>
<a class="inlineBoxes" href="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_downloadContainer.66ea.png" data-lightbox="0" title="Téléchargement du container">
        <img class="medium" src="/images/posts/2016-03-AndroidGoogleTagManager/GoogleTagManager_downloadContainer_min.6ff9.png" alt="Téléchargement du container"/>
</a></p>
</div>
<div class="paragraph">
<p></div>
<br/></p>
</div>
<div class="paragraph">
<p>Normalement arrivé là, vous avez configuré un container avec une variable dans celui-ci. Et vous disposez pour ce container de son <em>code unique</em> ainsi que d&#8217;un <em>binaire</em> de son contenu.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_android_le_code">Application Android : Le code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La seconde partie du travail consiste à modifier son code applicatif afin de lire la variable précédemment ajoutée dans Google Tag Manager.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pour commencer, stockez votre code Google Tag Manager (dans une constante ou un ficher xml, peu importe).</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;resources&gt;
    &lt;string name="tag_manager_id"&gt;GTM-N8NXMK&lt;/string&gt;
&lt;/resources&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensuite copiez le binaire téléchargé (correspondant à la configuration initiale du container) dans le répertoire <em>/res/raw/</em>, attention vous devrez surement changer le nom du fichier pour enlever les majuscules.</p>
</li>
<li>
<p>Ajoutez dans votre <em>build.gradle</em> une nouvelle dépendance vers les play services (seulement la partie analytics nous intéresse).</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">dependencies {
    compile 'com.google.android.gms:play-services-analytics:8.4.0'
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Maintenant dans une Activity (ou bien dans votre Application), vous avez deux choses à faire, récupérer une instance de TagManager et faire une requête pour lire la configuration actuelle du Container.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        final TagManager tagManager = TagManager.getInstance(this);
        PendingResult pending = tagManager.loadContainerPreferFresh(getString(R.string.tag_manager_id), R.raw.gtm_initial_conf);
        pending.setResultCallback(new ResultCallback&lt;ContainerHolder&gt;() {
           @Override
           public void onResult(@NonNull ContainerHolder containerHolder) {
               // If unsuccessful, return
               if (!containerHolder.getStatus().isSuccess()) {
                   // Deal with failure
                   return;
               }
               containerHolder.refresh();

               final boolean feature1Status = containerHolder.getContainer().getBoolean("feature1");
               Log.d("TagManager", String.valueOf(feature1Status));
           }
        }, 2, TimeUnit.SECONDS);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et c&#8217;est tout ! Vous pouvez retourner dans l&#8217;interface de Tag Manager, pour modifier la valeur de la variable feature1, publiez la nouvelle version du container et si vous redémarrez l&#8217;application,
 la nouvelle valeur devrait apparaitre.</p>
</div>
<div class="paragraph">
<p>Rapide et efficace, non ?</p>
</div>
<div class="sect2">
<h3 id="_chargement_des_données_du_container">Chargement des données du container</h3>
<div class="paragraph">
<p>Via l&#8217;instance de TagManager différentes méthodes sont disponibles pour charger le container et les valeurs qu&#8217;il contient.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">tagManager.loadContainerDefaultOnly(...); <b class="conum">(1)</b>
tagManager.loadContainerPreferFresh(...); <b class="conum">(2)</b>
tagManager.loadContainerPreferNonDefault(...); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>va uniquement regarder les valeurs dans le binaire ajouté dans /res/raw</p>
</li>
<li>
<p>vont essayer de prendre les dernières valeurs publiées (ou non) mais sans être garantie à 100% (notamment s&#8217;il ya des problèmes de réseaux)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les différences sont détaillées <a href="https://developers.google.com/android/reference/com/google/android/gms/tagmanager/TagManager#public-methods">dans la doc</a>.
Mais selon toute logique cette qui va nous intéresser sera uniquement <code>loadContainerPreferFresh()</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les pour et les contre d&#8217;utiliser Tag Manager pour faire du feature toggle vont forcément dépendre du besoin du développeur.</p>
</div>
<div class="sect2">
<h3 id="_pour">Pour</h3>
<div class="paragraph">
<p>Le principale avantage et la mise en place sans le développement d&#8217;une API rien que pour ça (si votre application n&#8217;a pas de backend dédié, pas besoin d&#8217;en créer un).<br>
Toute la logique de configuration initiale versus configuration mise à jour est déjà implémentée et tout se gère via l&#8217;appel <code>tagManager.loadContainer()</code>.<br>
Ça fonctionne tout aussi bien sur iOS.<br>
Un autre point très intéressant (et non abordé ici) est la publication d&#8217;une variable selon des critères (on va pouvoir modifier un toggle, pour par exemple faire du A/B testing en fonction d&#8217;un tas de critères comme la taille de l&#8217;écran ou bien la langue de l&#8217;utilisateur ou même la version de l&#8217;application).</p>
</div>
</div>
<div class="sect2">
<h3 id="_contre">Contre</h3>
<div class="paragraph">
<p>Si le <code>loadPreferFresh</code> échoue (problème réseau par exemple) on retombe sur la config par défaut, mais est-ce que ça fonctionnerait mieux avec une solution custom ? par sûr.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_liens">Liens</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Code sources d&#8217;exemple : <a href="https://github.com/fchauveau/blog-android-tag-manager" class="bare">https://github.com/fchauveau/blog-android-tag-manager</a><br>
Documentation Google officielle : <a href="https://developers.google.com/tag-manager/android/v4/" class="bare">https://developers.google.com/tag-manager/android/v4/</a><br>
Cours Udacity d&#8217;explication : <a href="https://www.udacity.com/course/viewer#!/c-ud876-2/l-4027658558/m-4328729937" class="bare">https://www.udacity.com/course/viewer#!/c-ud876-2/l-4027658558/m-4328729937</a></p>
</div>
</div>
</div>

                </div>
                <div class="content-footer">
                
                <ul class="tags float">
                    
                    <li><a href="/tags/android/">Android</a></li>
                    
                    <li><a href="/tags/google-tag-manager/">Google Tag Manager</a></li>
                    
                    <li><a href="/tags/feature-toggle/">Feature Toggle</a></li>
                    
                </ul>
                
                <section id="author">
                    <div class="date">Rédigé par <span class="author-name">Florian</span></div>
                </section>
                </div>
                <div class="share">
                    <span>Partager</span>
                    <ul class="socials">
                        <li>
                            <a target="_blank" title="Facebook"
                               href="https://www.facebook.com/sharer.php?u=http://code-troopers.com%2f2016%2f03%2f30%2fandroid_google_tag_manager_feature_toggle%2f&t=Android%20%3a%20Feature%20Toggle%20avec%20Google%20Tag%20Manager"
                               class="facebook-button" rel="nofollow"
                               onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;">
                                <i class="fa fa-facebook"></i>
                            </a>
                        </li>
                        <li>
                            <a target="_blank" title="Twitter"
                               href="https://twitter.com/share?url=http://code-troopers.com%2f2016%2f03%2f30%2fandroid_google_tag_manager_feature_toggle%2f&text=Android%20%3a%20Feature%20Toggle%20avec%20Google%20Tag%20Manager&via=codetroopers"
                               rel="nofollow"
                               onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;">
                                <i class="fa fa-twitter"></i>
                            </a>
                        </li>
                        <li>
                            <a target="_blank" title="Google +"
                               href="https://plus.google.com/share?url=http://code-troopers.com%2f2016%2f03%2f30%2fandroid_google_tag_manager_feature_toggle%2f&hl=fr"
                               class="google-button" rel="nofollow"
                               onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
                                <i class="fa fa-google-plus"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                <div style="clear:both"></div>


                <div class="back">
                    <div class="pagination">
                        
                        <a href="/2016/05/11/vim_macro/" class="previous-page">
                            <div class="arrow"><div class="arrow_box_left arrow_box">
</div></div>
                            Article précédent
                        </a>
                        
                        
                        <a href="/2016/01/20/jenkinsworkflow/" class="next-page">
                            Article suivant
                            <div class="arrow"><div class="arrow_box_right arrow_box">
</div></div>
                        </a>
                        
                    </div>
                </div>

                <section id="menu">
                    <ul>
                        
                    </ul>
                </section>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                   
                  var disqus_shortname = 'codetroopers' 
                  var disqus_url = window.location.href
                  if (window.location.protocol != 'http:') {
                    disqus_url = 'http:' + window.location.href.substring(window.location.protocol.length)
                  }

                   
                  (function () {
                    var dsq = document.createElement('script')
                    dsq.type = 'text/javascript'
                    dsq.async = true
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
                  })()
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments
                    powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span
                        class="logo-disqus">Disqus</span></a>

        </div>
        </article>
        </div>
    </section>
</section>

<section id="contact">
    <h1>Contact</h1>


    <div>
        <div>
            <img src="/img/map.4fac.jpg" alt="Map">
        </div>
        <div>
            <h2>Code-Troopers</h2>
            <p>
                <strong>MAME</strong><br>
                Cité de la création et du numérique<br>
                49 boulevard Preuilly<br>
                37 000 Tours - Fr
            </p>
            <a href="tel:+330782287216">0782 287 216</a>
        </div>
    </div>

    <h1>Suivez nos actualités</h1>

    <ul class="flex">
        <li>
            <a href="https://facebook.com/codetroopers37">
                <i class="fa fa-facebook fa-3x fa-fw">&nbsp;</i>
            </a>
        </li>
        <li>
            <a href="https://twitter.com/codetroopers">
                <i class="fa fa-twitter fa-3x fa-fw">&nbsp;</i>
            </a>
        </li>
        <li>
            <a href="https://plus.google.com/+Code-troopers">
                <i class="fa fa-google-plus fa-3x fa-fw">&nbsp;</i>
            </a>
        </li>
        <li>
            <a href="https://github.com/code-troopers">
                <i class="fa fa-github fa-3x fa-fw">&nbsp;</i>
            </a>
        </li>
    </ul>
</section>

<footer>
    <div class="wrapper">
        <a href="#top">
            <img class="arrow" src="/img/arrow.67dc.png" alt="arrow">
        </a>
        <img src="/img/footer_logo.a13b.png" alt="logo">
        <div>
            <span>©2014 — 2018 Code-Troopers | <a href="/mentions.html">Mentions légales</a></span>
            <span>Design : <a href="https://www.descheval.com/">descheval.com</a> | Développement : Code-Troopers</span>
        </div>
    </div>
</footer>
<script src="/main.47676c.js"></script>
</body>
</html>

